const historyEl = document.getElementById('history');
const textIn = document.getElementById('textIn');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clearBtn');
const statusEl = document.getElementById('status');

/* ====== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π ====== */
function appendMessage(text, who='bot'){
    const div = document.createElement('div');
    div.className = 'jarvis-msg ' + (who === 'user' ? 'jarvis-user' : 'jarvis-bot');
    div.textContent = text;
    historyEl.appendChild(div);
    historyEl.scrollTop = historyEl.scrollHeight;
}

/* ====== –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ ====== */
function matchAny(str, keywords){
    str = str.toLowerCase().replace(/[^a-z–∞-—è”ô“ì“õ“£”©“Ø“ª—ñ0-9]/gi, ' ');
    return keywords.some(kw => str.includes(kw));
}

/* ====== –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞–±–∏–Ω–µ—Ç–æ–≤ ====== */
const classrooms = {
    // IT-–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    'it': [
        { number: '101', name: '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π –∫–ª–∞—Å—Å', floor: 1, description: '–û—Å–Ω–æ–≤—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏' },
        { number: '102', name: '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∏', floor: 1, description: '–°–±–æ—Ä–∫–∞ –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–±–æ—Ç–æ–≤ Lego Mindstorms' },
        { number: '103', name: '3D-–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ', floor: 1, description: '3D-–ø–µ—á–∞—Ç—å –∏ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Blender' },
        { number: '201', name: '–ö–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å', floor: 2, description: '–û—Å–Ω–æ–≤—ã –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏' },
        { number: '202', name: '–í–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞', floor: 2, description: '–°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–æ–≤ –∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π' }
    ],
    
    // –ù–∞—É—á–Ω–æ-–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    'science': [
        { number: '301', name: '–ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', floor: 3, description: '–ú–∏–∫—Ä–æ—Å–∫–æ–ø—ã –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' },
        { number: '302', name: '–•–∏–º–∏—á–µ—Å–∫–∞—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', floor: 3, description: '–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ö–∏–º–∏—á–µ—Å–∫–∏—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤' },
        { number: '303', name: '–ö–∞–±–∏–Ω–µ—Ç —ç–∫–æ–ª–æ–≥–∏–∏', floor: 3, description: '–ò–∑—É—á–µ–Ω–∏–µ –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã' },
        { number: '304', name: '–ì–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∞', floor: 3, description: '–í—ã—Ä–∞—â–∏–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏–π –±–µ–∑ –ø–æ—á–≤—ã' }
    ],
    
    // –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ-—ç—Å—Ç–µ—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    'art': [
        { number: '401', name: '–•–æ—Ä–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∑–∞–ª', floor: 4, description: '–ó–µ—Ä–∫–∞–ª—å–Ω—ã–π –∑–∞–ª –¥–ª—è —Ç–∞–Ω—Ü–µ–≤' },
        { number: '402', name: '–¢–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è —Å—Ç—É–¥–∏—è', floor: 4, description: '–°—Ü–µ–Ω–∞ –∏ —Ç–µ–∞—Ç—Ä–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' },
        { number: '403', name: '–ò–∑–æ—Å—Ç—É–¥–∏—è', floor: 4, description: '–ú–æ–ª—å–±–µ—Ä—Ç—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è' },
        { number: '404', name: '–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å', floor: 4, description: '–§–æ—Ä—Ç–µ–ø–∏–∞–Ω–æ –∏ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã' },
        { number: '405', name: '–§–æ—Ç–æ—Å—Ç—É–¥–∏—è', floor: 4, description: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' }
    ],
    
    // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –æ–±—â–∏–µ –ø–æ–º–µ—â–µ–Ω–∏—è
    'admin': [
        { number: '001', name: '–ü—Ä–∏–µ–º–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞', floor: 1, description: '–ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏' },
        { number: '002', name: '–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç', floor: 1, description: '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π' },
        { number: '003', name: '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è', floor: 1, description: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã' },
        { number: '004', name: '–ú–µ–¥–ø—É–Ω–∫—Ç', floor: 1, description: '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å' },
        { number: '005', name: '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞', floor: 1, description: '–ß–∏—Ç–∞–ª—å–Ω—ã–π –∑–∞–ª –∏ –∫–Ω–∏–∂–Ω—ã–π —Ñ–æ–Ω–¥' },
        { number: '006', name: '–°—Ç–æ–ª–æ–≤–∞—è', floor: 1, description: '–ü–∏—Ç–∞–Ω–∏–µ —É—á–∞—â–∏—Ö—Å—è' },
        { number: '007', name: '–ê–∫—Ç–æ–≤—ã–π –∑–∞–ª', floor: 1, description: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ —Å–æ–±—Ä–∞–Ω–∏—è' }
    ]
};

/* ====== –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–∞–±–∏–Ω–µ—Ç–∞ ====== */
function findClassroom(query) {
    const normalizedQuery = query.toLowerCase().replace(/[^a-z–∞-—è”ô“ì“õ“£”©“Ø“ª—ñ0-9]/gi, ' ').trim();
    
    // –ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∫–∞–±–∏–Ω–µ—Ç–∞
    for (const category in classrooms) {
        const room = classrooms[category].find(r => 
            r.number === normalizedQuery || 
            normalizedQuery.includes(r.number)
        );
        if (room) return room;
    }
    
    // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    for (const category in classrooms) {
        const room = classrooms[category].find(r => 
            normalizedQuery.includes(r.name.toLowerCase()) ||
            r.name.toLowerCase().includes(normalizedQuery)
        );
        if (room) return room;
    }
    
    // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é
    if (matchAny(normalizedQuery, ['it', '–∞–π—Ç–∏', '–∫–æ–º–ø—å—é—Ç–µ—Ä', '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä'])) {
        return { category: 'it', description: 'IT-–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ 1-2 —ç—Ç–∞–∂–∞—Ö' };
    }
    if (matchAny(normalizedQuery, ['–Ω–∞—É–∫–∞', '–±–∏–æ–ª–æ–≥', '—Ö–∏–º', '–ª–∞–±–æ—Ä–∞—Ç–æ—Ä'])) {
        return { category: 'science', description: '–ù–∞—É—á–Ω—ã–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ 3 —ç—Ç–∞–∂–µ' };
    }
    if (matchAny(normalizedQuery, ['–∏—Å–∫—É—Å—Å—Ç–≤', '—Ç–≤–æ—Ä—á', '—Ç–∞–Ω—Ü', '—Ç–µ–∞—Ç—Ä', '–º—É–∑—ã–∫', '—Ä–∏—Å–æ–≤–∞–Ω'])) {
        return { category: 'art', description: '–¢–≤–æ—Ä—á–µ—Å–∫–∏–µ —Å—Ç—É–¥–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ 4 —ç—Ç–∞–∂–µ' };
    }
    
    return null;
}

/* ====== –õ–æ–≥–∏–∫–∞ –∞–≥–µ–Ω—Ç–∞ ====== */
function agentResponse(input){
    if(!input) return "–°–∫–∞–∂–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å :)";

    const s = input.toLowerCase();

    // ===== –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è =====
    if (/^(hello|hi|hey)/.test(s)) {
        const greetings = [
            "Hello! I am an interactive assistant at the Petropavlovsk Schoolchildren's Palace. How can I help?",
            "Good afternoon! Ask me about clubs, directions, classrooms or events."
        ];
        return greetings[Math.floor(Math.random() * greetings.length)];
    }

    if (/^(—Å–∞–ª–µ–º|—Å–∞–ª–µ–º–µ|—Å”ô–ª–µ–º)/.test(s)) {
        const greetings = [
            "–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑–¥–µ—Ä –º–µ! –ú–µ–Ω –ü–µ—Ç—Ä–æ–ø–∞–≤–ª “õ–∞–ª–∞–ª—ã“õ –û“õ—É—à—ã–ª–∞—Ä —Å–∞—Ä–∞–π—ã–Ω—ã“£ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ –∫”©–º–µ–∫—à—ñ—Å—ñ–º—ñ–Ω. “ö–∞–ª–∞–π –∫”©–º–µ–∫—Ç–µ—Å–µ –∞–ª–∞–º—ã–Ω?",
            "“ö–∞–π—ã—Ä–ª—ã –∫“Ø–Ω! –ú–µ–Ω —Å—ñ–∑–≥–µ –û“õ—É—à—ã–ª–∞—Ä —Å–∞—Ä–∞–π—ã–Ω–¥–∞ –∂–æ–ª –∫”©—Ä—Å–µ—Ç–µ–º—ñ–Ω. –ö–ª—É–±—Ç–∞—Ä, –±”©–ª–º–µ–ª–µ—Ä –Ω–µ–º–µ—Å–µ –æ“õ–∏“ì–∞–ª–∞—Ä —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞“£—ã–∑."
        ];
        return greetings[Math.floor(Math.random() * greetings.length)];
    }

    if (/^(–ø—Ä–∏–≤|–∑–¥—Ä)/.test(s)) {
        const greetings = [
            "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –î–≤–æ—Ä—Ü–∞ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫–∞. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
            "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –°–ø—Ä–æ—Å–∏—Ç–µ –º–µ–Ω—è –æ –∫—Ä—É–∂–∫–∞—Ö, –∫–∞–±–∏–Ω–µ—Ç–∞—Ö, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –∏–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö."
        ];
        return greetings[Math.floor(Math.random() * greetings.length)];
    }

    // ===== –ü–æ–∏—Å–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è =====
    if (matchAny(s, ['–∫–∞–±–∏–Ω–µ—Ç', '–∞—É–¥–∏—Ç–æ—Ä', '–∫–æ–º–Ω–∞—Ç–∞', '–±”©–ª–º–µ', '–∫–ª–∞—Å—Å', '–∫–∞–∫ –Ω–∞–π—Ç–∏', '–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è', '–≥–¥–µ –Ω–∞–π—Ç–∏', '“õ–∞–π–¥–∞', '–º–µ–∫–µ–Ω–∂–∞–π'])) {
        const classroom = findClassroom(s);
        
        if (classroom && classroom.number) {
            // –ù–∞–π–¥–µ–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
            const floorText = classroom.floor === 1 ? '1 —ç—Ç–∞–∂–µ' : `${classroom.floor} —ç—Ç–∞–∂–µ`;
            const directions = [
                `–ö–∞–±–∏–Ω–µ—Ç ${classroom.number} (¬´${classroom.name}¬ª) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ ${floorText}. ${classroom.description}`,
                `–ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ ${classroom.name} (–∫–∞–±–∏–Ω–µ—Ç ${classroom.number}): –ø–æ–¥–Ω–∏–º–∏—Ç–µ—Å—å –Ω–∞ ${floorText}. ${classroom.description}`,
                `${classroom.name} —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω –≤ –∫–∞–±–∏–Ω–µ—Ç–µ ${classroom.number} –Ω–∞ ${floorText}. ${classroom.description}`
            ];
            return directions[Math.floor(Math.random() * directions.length)];
        } else if (classroom && classroom.category) {
            // –ù–∞–π–¥–µ–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            return classroom.description;
        } else {
            // –ö–∞–±–∏–Ω–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
            const suggestions = [
                "–Ø –º–æ–≥—É –ø–æ–º–æ—á—å –Ω–∞–π—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç. –£—Ç–æ—á–Ω–∏—Ç–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫–∞–±–∏–Ω–µ—Ç 101?' –∏–ª–∏ '–ö–∞–∫ –Ω–∞–π—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∏?'",
                "–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—Ä—É–∂–∫–∞, –∏ —è –ø–æ–∫–∞–∂—É, –∫–∞–∫ —Ç—É–¥–∞ –¥–æ–±—Ä–∞—Ç—å—Å—è. –ù–∞–ø—Ä–∏–º–µ—Ä: '–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è' –∏–ª–∏ '–∫–∞–±–∏–Ω–µ—Ç 301'",
                "–î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —É—Ç–æ—á–Ω–∏—Ç–µ: –Ω–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (IT, –Ω–∞—É–∫–∞, –∏—Å–∫—É—Å—Å—Ç–≤–æ) –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫—Ä—É–∂–æ–∫"
            ];
            return suggestions[Math.floor(Math.random() * suggestions.length)];
        }
    }

    // ===== –≠—Ç–∞–∂–∏ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ =====
    if (matchAny(s, ['—ç—Ç–∞–∂', '“õ–∞–±–∞—Ç', 'floor', '–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞', '—Å—Ö–µ–º–∞'])) {
        return "–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –î–≤–æ—Ä—Ü–∞ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤:\n\n" +
               "üîπ 1 —ç—Ç–∞–∂: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è, IT-–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, —Å—Ç–æ–ª–æ–≤–∞—è, –∞–∫—Ç–æ–≤—ã–π –∑–∞–ª\n" +
               "üîπ 2 —ç—Ç–∞–∂: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ IT-–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏\n" + 
               "üîπ 3 —ç—Ç–∞–∂: –ù–∞—É—á–Ω–æ-–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏\n" +
               "üîπ 4 —ç—Ç–∞–∂: –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ-—ç—Å—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç—É–¥–∏–∏\n\n" +
               "–£—Ç–æ—á–Ω–∏—Ç–µ, –∫–∞–∫–æ–π –∫–∞–±–∏–Ω–µ—Ç –∏–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç!";
    }

    // ===== –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞–±–∏–Ω–µ—Ç—ã =====
    if (matchAny(s, ['—Ä–æ–±–æ—Ç', '–ª–µ–≥–æ', '—Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫'])) {
        return "üöÄ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–∞–±–∏–Ω–µ—Ç–µ 102 –Ω–∞ 1 —ç—Ç–∞–∂–µ. –ó–¥–µ—Å—å —Å–æ–±–∏—Ä–∞—é—Ç –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä—É—é—Ç —Ä–æ–±–æ—Ç–æ–≤ Lego Mindstorms. –ß—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å: –æ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –ø—Ä—è–º–æ, –∑–∞—Ç–µ–º –Ω–∞–ª–µ–≤–æ.";
    }

    if (matchAny(s, ['3d', '—Ç—Ä–µ—Ö–º–µ—Ä', '–ø—Ä–∏–Ω—Ç–µ—Ä'])) {
        return "üñ®Ô∏è –ö–∞–±–∏–Ω–µ—Ç 3D-–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è (103) –Ω–∞ 1 —ç—Ç–∞–∂–µ. –û–±–æ—Ä—É–¥–æ–≤–∞–Ω 3D-–ø—Ä–∏–Ω—Ç–µ—Ä–∞–º–∏ –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞–º–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π. –†—è–¥–æ–º —Å –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–µ–π —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∏.";
    }

    if (matchAny(s, ['—Ç–∞–Ω—Ü', '—Ö–æ—Ä–µ–æ–≥—Ä–∞—Ñ'])) {
        return "üíÉ –•–æ—Ä–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∑–∞–ª (401) –Ω–∞ 4 —ç—Ç–∞–∂–µ. –ü—Ä–æ—Å—Ç–æ—Ä–Ω—ã–π –∑–∞–ª —Å –∑–µ—Ä–∫–∞–ª–∞–º–∏ –∏ —Å—Ç–∞–Ω–∫–∞–º–∏. –õ–∏—Ñ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–ø—Ä–∞–≤–∞ –æ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –≤—Ö–æ–¥–∞.";
    }

    if (matchAny(s, ['—Ç–µ–∞—Ç—Ä', '—Å—Ü–µ–Ω–∞'])) {
        return "üé≠ –¢–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è —Å—Ç—É–¥–∏—è (402) –Ω–∞ 4 —ç—Ç–∞–∂–µ. –û—Å–Ω–∞—â–µ–Ω–∞ —Å—Ü–µ–Ω–æ–π, –≥—Ä–∏–º–µ—Ä–Ω—ã–º–∏ –∏ —Ç–µ–∞—Ç—Ä–∞–ª—å–Ω—ã–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º. –†—è–¥–æ–º —Å —Ö–æ—Ä–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º –∑–∞–ª–æ–º.";
    }

    if (matchAny(s, ['–¥–∏—Ä–µ–∫—Ç–æ—Ä', '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü', '–ø—Ä–∏–µ–º–Ω–∞—è'])) {
        return "üëî –ü—Ä–∏–µ–º–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ (001) –Ω–∞ 1 —ç—Ç–∞–∂–µ. –°—Ä–∞–∑—É –ø—Ä–∏ –≤—Ö–æ–¥–µ –Ω–∞–ø—Ä–∞–≤–æ. –ß–∞—Å—ã –ø—Ä–∏–µ–º–∞: –ü–Ω-–ü—Ç 10:00-12:00, 15:00-17:00.";
    }

    if (matchAny(s, ['—Å—Ç–æ–ª–æ–≤', '–µ–¥–∞', '–∫—É—à'])) {
        return "üçΩÔ∏è –°—Ç–æ–ª–æ–≤–∞—è (006) –Ω–∞ 1 —ç—Ç–∞–∂–µ. –í –ª–µ–≤–æ–º –∫—Ä—ã–ª–µ –∑–¥–∞–Ω–∏—è. –ü–∏—Ç–∞–Ω–∏–µ: –∑–∞–≤—Ç—Ä–∞–∫ 9:00-10:00, –æ–±–µ–¥ 13:00-14:00.";
    }

    // ===== –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã =====
    if(matchAny(s, ['–∫–∞–∫ –¥–µ–ª–∞','how are you','“õ–∞–ª–¥–∞—Ä—ã“£—ã–∑ “õ–∞–ª–∞–π','“õ–∞–ª–∞–π—Å—ã“£—ã–∑'])) {
        const replies = [
            "–°–ø–∞—Å–∏–±–æ, –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –ø–æ –î–≤–æ—Ä—Ü—É —à–∫–æ–ª—å–Ω–∏–∫–æ–≤! üòä",
            "I am your guide to the Schoolchildren's Palace. Ready to help you find any classroom!",
            "–†–∞—Ö–º–µ—Ç, –±”ô—Ä—ñ —Ç–∞–º–∞—à–∞! –û“õ—É—à—ã–ª–∞—Ä —Å–∞—Ä–∞–π—ã–Ω–¥–∞ –∂–æ–ª –∫”©—Ä—Å–µ—Ç—É–≥–µ –¥–∞–π—ã–Ω–º—ã–Ω! üòä"
        ];
        return replies[Math.floor(Math.random() * replies.length)];
    }

    if(matchAny(s, ['–ø–æ–∫–∞','bye','—Å–∞—É –±–æ–ª—ã“£—ã–∑'])) {
        const replies = [
            "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –ï—Å–ª–∏ –∑–∞–±–ª—É–¥–∏—Ç–µ—Å—å - –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å, –ø–æ–º–æ–≥—É —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è!",
            "Goodbye! Come back if you need directions to any classroom!",
            "“ö–æ—à –±–æ–ª—ã“£—ã–∑! –ï–≥–µ—Ä –∂–æ–ª—ã“£—ã–∑–¥—ã —Ç–∞–ø–ø–∞—Å–∞“£—ã–∑, –∫–µ—Ä—ñ –æ—Ä–∞–ª—ã“£—ã–∑ - –∂–æ–ª –∫”©—Ä—Å–µ—Ç–µ–º—ñ–Ω!"
        ];
        return replies[Math.floor(Math.random() * replies.length)];
    }

    if(matchAny(s, ['–∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç','what is your name','—Å–µ–Ω –∫—ñ–º—Å—ñ“£'])) {
        const replies = [
            "–ú–µ–Ω –î–∂–∞—Ä–≤–∏—Å, –û“õ—É—à—ã–ª–∞—Ä —Å–∞—Ä–∞–π—ã–Ω—ã“£ –∫”©–º–µ–∫—à—ñ—Å—ñ–º—ñ–Ω. –°–∞—Ä–∞–π–¥—ã“£ –∫–µ–∑ –∫–µ–ª–≥–µ–Ω –±”©–ª–º–µ—Å—ñ–Ω–µ –∂–æ–ª –∫”©—Ä—Å–µ—Ç–µ –∞–ª–∞–º—ã–Ω!",
            "I am Jarvis, your navigation assistant in the Schoolchildren's Palace. I can guide you to any classroom!",
            "–ú–µ–Ω –î–∂–∞—Ä–≤–∏—Å, –ü–µ—Ç—Ä–æ–ø–∞–≤–ª “õ–∞–ª–∞—Å—ã–Ω–¥–∞“ì—ã –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ –≥–∏–¥—ñ–º—ñ–Ω. –ö–µ–∑ –∫–µ–ª–≥–µ–Ω –∫–∞–±–∏–Ω–µ—Ç–∫–µ –∂–æ–ª –∫”©—Ä—Å–µ—Ç–µ –∞–ª–∞–º—ã–Ω! üòä"
        ];
        return replies[Math.floor(Math.random() * replies.length)];
    }

    // ===== –ê–¥—Ä–µ—Å –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã =====
    if(matchAny(s, ['–∞–¥—Ä–µ—Å','address','–º–µ–∫–µ–Ω–∂–∞–π','contact','—Ç–µ–ª–µ—Ñ–æ–Ω','place'])) {
        const replies = [
            "–î–≤–æ—Ä–µ—Ü —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: –≥. –ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫, —É–ª. –ñ–∞–º–±—ã–ª–∞ –ñ–∞–±–∞–µ–≤–∞, 55 –ê. –¢–µ–ª–µ—Ñ–æ–Ω: 8 7152 34-02-44. –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –≤–Ω—É—Ç—Ä–∏ –∑–¥–∞–Ω–∏—è?",
            "The Schoolchildren's Palace is located at: Petropavlovsk, st. Zhambyla Zhabaeva, 55 A. Telephone: 8 7152 34-02-44. Need directions inside the building?",
            "–û“õ—É—à—ã–ª–∞—Ä —Å–∞—Ä–∞–π—ã –º—ã–Ω–∞ –º–µ–∫–µ–Ω–∂–∞–π–¥–∞ –æ—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω: –ü–µ—Ç—Ä–æ–ø–∞–≤–ª “õ., –∫”©—à. –ñ–∞–º–±—ã–ª –ñ–∞–±–∞–µ–≤–∞, 55 –ê. –¢–µ–ª–µ—Ñ–æ–Ω: 8 7152 34-02-44. “í–∏–º–∞—Ä–∞—Ç —ñ—à—ñ–Ω–¥–µ –∂–æ–ª –∫”©—Ä—Å–µ—Ç—É –∫–µ—Ä–µ–∫ –ø–µ?"
        ];
        return replies[Math.floor(Math.random() * replies.length)];
    }

    // ===== –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è =====
    if(matchAny(s, ['–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω','–∫—Ä—É–∂–∫','–∑–∞–Ω—è—Ç','club','–∫–ª—É–±','program','–¥–∏—Å—Ü–∏–ø–ª–∏–Ω'])) {
        return "–í–æ –î–≤–æ—Ä—Ü–µ –±–æ–ª–µ–µ 90 –∫—Ä—É–∂–∫–æ–≤ –ø–æ —Ç—Ä—ë–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º:\n\n" +
               "üíª IT-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (1-2 —ç—Ç–∞–∂–∏): –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∞, 3D-–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ\n" +
               "üî¨ –ù–∞—É—á–Ω–æ-–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ (3 —ç—Ç–∞–∂): –±–∏–æ–ª–æ–≥–∏—è, —Ö–∏–º–∏—è, —ç–∫–æ–ª–æ–≥–∏—è, –≥–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∞\n" +
               "üé® –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ-—ç—Å—Ç–µ—Ç–∏—á–µ—Å–∫–æ–µ (4 —ç—Ç–∞–∂): —Ç–∞–Ω—Ü—ã, —Ç–µ–∞—Ç—Ä, –º—É–∑—ã–∫–∞, —Ä–∏—Å–æ–≤–∞–Ω–∏–µ\n\n" +
               "80% –∫—Ä—É–∂–∫–æ–≤ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ! –£—Ç–æ—á–Ω–∏—Ç–µ, –∫–∞–∫–æ–π –∫–∞–±–∏–Ω–µ—Ç –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?";
    }

    // ===== –ï—Å–ª–∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ =====
    const randomReplies = [
        "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞: –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –∫–∞–∫ –∫—É–¥–∞-—Ç–æ –ø—Ä–æ–π—Ç–∏?",
        "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É. –ù–∞–ø—Ä–∏–º–µ—Ä: '–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫–∞–±–∏–Ω–µ—Ç 101?' –∏–ª–∏ '–ö–∞–∫ –ø—Ä–æ–π—Ç–∏ –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∏?'",
        "I can help with navigation! Try asking: 'Where is classroom 201?' or 'How to find the robotics lab?'",
        "–ú–µ–Ω –∂–æ–ª –∫”©—Ä—Å–µ—Ç–µ –∞–ª–∞–º—ã–Ω! –ú—ã—Å–∞–ª—ã: '102 –±”©–ª–º–µ “õ–∞–π–¥–∞?' –Ω–µ–º–µ—Å–µ '–†–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∞ –∑–µ—Ä—Ç—Ö–∞–Ω–∞—Å—ã–Ω–∞ “õ–∞–ª–∞–π –±–∞—Ä—É“ì–∞ –±–æ–ª–∞–¥—ã?' —Å“±—Ä–∞“£—ã–∑"
    ];
    return randomReplies[Math.floor(Math.random() * randomReplies.length)];
}

/* ====== –û–∑–≤—É—á–∫–∞ ====== */
let synth = window.speechSynthesis;
let voices = [];
function loadVoices(){
    voices = synth.getVoices();
}
if(synth){
    loadVoices();
    window.speechSynthesis.onvoiceschanged = loadVoices;
}

function speak(text){
    if(!synth) return;

    const utt = new SpeechSynthesisUtterance(text);
    let lang = 'ru-RU';
    if(text.match(/[a-z]/i)) lang = 'en-US';
    if(text.match(/[\u0400-\u04FF]/)) lang = 'ru-RU';
    if(text.match(/[\u0600-\u06FF\u0400-\u04FF\u0430-\u044F]/)) lang = 'kk-KZ';

    const voice = voices.find(v => v.lang.startsWith(lang)) || voices[0];
    if(voice) utt.voice = voice;

    utt.rate = 1.2;
    utt.pitch = 1;
    utt.volume = 1.0;

    synth.speak(utt);
}

/* ====== –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ====== */
appendMessage('–ü—Ä–∏–≤–µ—Ç! –Ø –î–∂–∞—Ä–≤–∏—Å ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –î–≤–æ—Ä—Ü–∞ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫–∞. –Ø –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –ª—é–±–æ–π –∫–∞–±–∏–Ω–µ—Ç –∏ –ø–æ–¥—Å–∫–∞–∂—É, –∫–∞–∫ —Ç—É–¥–∞ –ø—Ä–æ–π—Ç–∏! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?', 'bot');

/* ====== –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ ====== */
sendBtn.onclick = () => {
    const text = textIn.value.trim();
    if(!text) return;
    appendMessage(text, 'user');
    const reply = agentResponse(text);
    setTimeout(() => {
        appendMessage(reply, 'bot');
        speak(reply);
    }, 500);
    textIn.value = '';
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
textIn.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        sendBtn.click();
    }
});

/* ====== –û—á–∏—Å—Ç–∫–∞ ====== */
clearBtn.onclick = () => { 
    historyEl.innerHTML = ''; 
    appendMessage('–ü—Ä–∏–≤–µ—Ç! –Ø –î–∂–∞—Ä–≤–∏—Å ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –î–≤–æ—Ä—Ü–∞ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫–∞. –Ø –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –ª—é–±–æ–π –∫–∞–±–∏–Ω–µ—Ç –∏ –ø–æ–¥—Å–∫–∞–∂—É, –∫–∞–∫ —Ç—É–¥–∞ –ø—Ä–æ–π—Ç–∏! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?', 'bot');
};